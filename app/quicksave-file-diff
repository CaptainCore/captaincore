#!/bin/bash

#
#   Grabs file diff between Quicksaves
#
#   `captaincore quicksave-file-diff <site> --hash=<git_hash> --file=<file>`
#
#   Example: captaincore quicksave-file-diff sitename 4c43c16ae40f384e93573133282bb86a46d040fd versions/plugins.json
#

# Load configuration
root_path="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"; root_path=${root_path%app*}
source ${root_path}config
source ${root_path}lib/arguments

run_command() {

	for website in "$@"; do

		eval $(captaincore site get $website --bash)

		# Return error if domain not found
		if [[ "$domain" == "" ]]; then
		  echo "Can't locate website for site $site"
		  return 1
		fi

		cd $path/${site}_${site_id}/quicksave/

		# capture all git commit into array
		git_commits=($(git log --pretty=format:"%H"))

		for i in ${!git_commits[@]}; do
			if [[ "${git_commits[$i]}" == "$hash" ]]; then
				current_index=$i
			fi
		done

		git_hash_previous=${git_commits[ $(( $current_index + 1 )) ]}
		git_diff=`git diff $hash $git_hash_previous -- $file`
		echo "$git_diff"

	done

}
run_command

# See if any sites are specifed
if [ ${#arguments[*]} -gt 0 ]; then
  # Runs on specific sites
  run_command ${arguments[*]}
fi

# Error if no sites specifed
if [ ${#arguments[*]} -eq 0 ]; then
  echo -e "${COLOR_RED}Error:${COLOR_NORMAL} Please specify one or more sites, or use --all."
fi
