#!/usr/bin/env bash

#
#   Generates quicksave for plugins and themes changes for one or more sites.
#
#   `captaincore quicksave generate <site>`
#
#   [<site>...]
#   One or more sites.
#
#   [@<target>]
#   Target groups of sites like @all @production or @staging.
#
#   [--parallel=<number>]
#   Number of Quicksaves at same time
#
#   [--force]
#   Force even if no changes were made.
#
#   [--debug]
#   Debug mode
#
#   [--skip-if-recent=<timeframe>]
#   Skip if quicksave generated or last checked within the specified timeframe (e.g., "24h", "7d").
#

if [ ${#@} -ne 1 ]; then
  echo -e "${COLOR_RED}Error:${COLOR_NORMAL} Please specify a <site>."
  exit
fi

while read config; do
  if [[ "$config" == "Error:"* ]]; then
    continue
  fi
  declare "$config"
done <<< "$(php ${CAPTAINCORE_PATH}/lib/local-scripts/configs.php fetch)"

site=$1

run_command() {

  # Extract environment
  if [[ "$site" == *"-staging"* ]]; then
      environment=staging
  else
      environment=production
  fi
  
  # Load site configs
  while read site_configs; do declare "$site_configs"; done <<< "$(captaincore site get $site --bash --captain-id=$CAPTAIN_ID)"

  # Return error if domain not found
  if [[ "$domain" == "" ]] || [[ "$site" == "" ]]; then
      echo "Can't locate website for $site"
      exit
  fi

  # --------------------------------------------------
  # Locking Mechanism
  # Prevent concurrent quicksaves on the same environment
  # --------------------------------------------------
  
  # Ensure the directory exists
  mkdir -p "$path/${site}_${site_id}/${environment}"
  lock_file="$path/${site}_${site_id}/${environment}/quicksave.lock"

  # Check if lock file exists
  if [ -f "$lock_file" ]; then
    local locked_pid
    locked_pid=$(cat "$lock_file")

    # Check if the process ID in the lock file is actually running
    if [ -n "$locked_pid" ] && ps -p "$locked_pid" > /dev/null 2>&1; then
      echo "Skipping $site ($environment) - Quicksave currently in process (PID: $locked_pid)"
      exit 0
    else
      # Process is dead, lock is stale. Clean up silently and proceed.
      rm -f "$lock_file"
    fi
  fi

  # Create the lock file with the current Process ID
  echo $$ > "$lock_file"

  # Ensure lock file is removed on script exit (Success, Error, or Interrupt)
  cleanup_lock() {
    rm -f "$lock_file"
  }
  trap cleanup_lock EXIT INT TERM

  # --------------------------------------------------
  # Auto-Resume / Skip Logic
  # Check if we processed this recently based on --skip-if-recent flag
  # --------------------------------------------------
  if [[ -n "$SKIP_IF_RECENT" ]]; then
    quicksave_list_file="$path/${site}_${site_id}/${environment}/quicksaves/list.json"
    should_skip=$(php ${CAPTAINCORE_PATH}/lib/local-scripts/check-last-run.php "$quicksave_list_file" "$SKIP_IF_RECENT")
    
    if [[ "$should_skip" == "true" ]]; then
      echo "Skipping $site ($environment) - Checked within last $SKIP_IF_RECENT."
      exit 0
    fi
  fi
  # --------------------------------------------------

  rclone_config_file="$path/${site}_${site_id}/rclone.conf"
  if [ ! -f "$rclone_config_file" ]; then
    captaincore site key-generate $site --captain-id=$CAPTAIN_ID
  fi

  # Lookup rclone
  remote_check=$( rclone config show $environment --config="$rclone_config_file" )

  if [[ $remote_check == *"Couldn't find type of fs"* ]]; then
    echo "$(date +'%Y-%m-%d %H:%M') Generating rclone configs for $site"
    captaincore site key-generate $site --captain-id=$CAPTAIN_ID
  fi

  # Captures FTP errors in $ftp_output and file listing to log file
  ftp_output=$( { rclone lsd ${environment}:$home_directory --config="$rclone_config_file" ; } 2>&1 )
  ftp_search_for_wordpress=$( echo "$ftp_output" | perl -wnE'say for /wp-admin/g' )

  # Handle FTP errors
  if [[ $ftp_search_for_wordpress != "wp-admin"* ]]; then
      echo "Can't locate WordPress for ${site}-${environment}"
      exit
  fi

  # Append trailing slash if home_directory exist
  if [ "$home_directory" != "" ]; then
      home_directory="${home_directory}/"
  fi

  quicksave_id_before=$( captaincore quicksave latest $site-$environment --field=hash --captain-id=$CAPTAIN_ID )
  echo "$(date +'%Y-%m-%d %H:%M') Begin quicksave for ${site}-${environment}"

  site_path="${site}_${site_id}/${environment}"

  # Create directory structure
  mkdir -p $path/$site_path/quicksave/mu-plugins
  mkdir -p $path/$site_path/quicksave/plugins
  mkdir -p $path/$site_path/quicksave/themes
  mkdir -p $path/$site_path/quicksave/versions

  cd $path/$site_path/quicksave/

  # Create new git repo if needed
  if [ ! -d ".git" ]; then
    git init
  fi

  # Sync DIRECTLY to quicksave folders
  # Note: Added --exclude ".git/**" to prevent rclone from messing with the repo metadata if a plugin contains a git repo.
  echo "Syncing themes..."
  rclone sync ${environment}:$home_directory${wp_content}/themes/ $path/$site_path/quicksave/themes/ --exclude .DS_Store --exclude *timthumb.txt --exclude "node_modules/**" --exclude ".git/**" --config="$rclone_config_file"

  echo "Syncing mu-plugins..."
  rclone sync ${environment}:$home_directory${wp_content}/mu-plugins/ $path/$site_path/quicksave/mu-plugins/ --exclude .DS_Store --exclude *timthumb.txt --exclude "node_modules/**" --exclude ".git/**" --config="$rclone_config_file"

  echo "Syncing plugins..."
  rclone sync ${environment}:$home_directory${wp_content}/plugins/ $path/$site_path/quicksave/plugins/ --exclude .DS_Store --exclude *timthumb.txt --exclude "node_modules/**" --exclude ".git/**" --config="$rclone_config_file"

  cd ${CAPTAINCORE_PATH}/data

  wp eval-file ../lib/local-scripts/sync-data.php $site-${environment}
  wp eval-file ../lib/local-scripts/quicksave-add.php site=$site environment=$environment

  # Remove git lock if found
  if [ -f "$path/$site_path/quicksave/.git/index.lock" ]; then
    rm "$path/$site_path/quicksave/.git/index.lock"
  fi

  captaincore quicksave list-generate $site-${environment} --captain-id=$CAPTAIN_ID
  quicksave_id_after=$( captaincore quicksave latest $site-$environment --field=hash --captain-id=$CAPTAIN_ID )

  if [[ "$quicksave_id_before" != "$quicksave_id_after" ]]; then
    cd $path/$site_path/quicksave/
    echo "$(date +'%Y-%m-%d %H:%M') Backing up /quicksave/ to restic repo"
    if [[ $( restic snapshots --repo rclone:$rclone_backup/${site}_${site_id}/${environment}/quicksave-repo --password-file="${CAPTAINCORE_PATH}/data/restic.key" ) == "" ]]; then
      echo "Generating new restic repo ${site}_${site_id}/${environment}/quicksave-repo"
      restic init --quiet --repo rclone:$rclone_backup/${site}_${site_id}/${environment}/quicksave-repo --password-file="${CAPTAINCORE_PATH}/data/restic.key"
    fi
    restic backup . --quiet --repo rclone:$rclone_backup/${site}_${site_id}/${environment}/quicksave-repo --exclude-file="${CAPTAINCORE_PATH}/lib/restic-excludes" --password-file="${CAPTAINCORE_PATH}/data/restic.key"
  fi

  # --------------------------------------------------
  # Touch list.json to update its modification timestamp
  # This marks the time this site was last processed, regardless of content changes.
  # --------------------------------------------------
  quicksave_list_file="$path/${site}_${site_id}/${environment}/quicksaves/list.json"
  if [ -f "$quicksave_list_file" ]; then
    touch "$quicksave_list_file"
  fi
  # --------------------------------------------------

  if [ -f "${path}/process-${process_id}-progress.log" ]; then
    echo -n "." >> ${path}/process-${process_id}-progress.log
  fi

}

run_command