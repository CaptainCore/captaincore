backupsnapshot=$@
backupformat=`echo $backupsnapshot | perl -n -e '/.+\.(.+)/&& print $1'`

# Store current path
homedir=$(pwd)

migrate_website() {

	# Find private folder
	if [ -d "_wpeprivate" ]; then
		private=${homedir}/_wpeprivate
	elif [ -d "../private" ]; then
		cd ../private
		private=$(pwd)
		cd $homedir
	else
		echo "Can't find private folder '/_wpeprivate' or '../private'. Migration cancelled.";
		return 1
	fi

	# Verifies WordPress
	wp_home=$(wp option get home --skip-themes --skip-plugins)
	if [[ "$wp_home" != "http"* ]]; then
		echo "WordPress not found. Migration cancelled.";
		return 1
	fi

	cd ~/private
	wget $backupsnapshot
	if [[ "$backupformat" == "zip" ]]; then
	  unzip -o *.zip
	fi
	if [[ "$backupformat" == "gz" ]]; then
	  tar xvzf *.gz
	fi
	if [[ "$backupformat" == "tar" ]]; then
	  tar xvzf *.tar
	fi
	wordpresspath=`find * -type d -name 'wp-content' -print -quit`
	rm -rf ~/public/wp-content/uploads
	mv $wordpresspath/uploads ~/public/wp-content/
	for d in $wordpresspath/themes/*/; do
	  mv $d ~/public/wp-content/themes/
	done
	for d in $wordpresspath/plugins/*/; do
	  mv $d ~/public/wp-content/plugins/
	done
	cd ~/public
	wp plugin delete wp-super-cache adminer wordfence w3-total-cache wp-file-cache broken-link-checker yet-another-related-posts-plugin comet-cache-1 woothemes-updater ewww-image-optimizer https-redirection really-simple-ssl hello wordpress-php-info force-strong-passwords --skip-plugins --skip-themes
	cat ~/private/$wordpresspath/../wp-config.php | grep "$table_prefix"
	rm -f ~/public/wp-content/advanced-cache.php
	rm -f ~/public/wp-content/object-cache.php
	cd ~/public/
	find . -type d -exec chmod 755 {} \;
	find . -type f -exec chmod 644 {} \;
	chmod 600 ~/public/wp-content/mysql.sql
	wp rewrite flush --skip-plugins --skip-themes
	echo "Found the following database:"
	find ~/public/wp-content/uploads ~/private/ -type f -name '*.sql'

}
migrate_website
